# UMIG API Error Handling Guide

**Document**: US-030 Comprehensive Error Documentation  
**Generated by**: GENDEV Security Analyzer Agent v2.3  
**Date**: August 18, 2025  
**Priority**: P0 Critical - UAT Readiness  
**Sprint**: 5 (August 18-22, 2025)

## Overview

This guide provides comprehensive error handling documentation for the UMIG API V2, enabling effective troubleshooting during UAT testing and production integration. All errors follow RESTful principles with consistent JSON response formats and actionable guidance.

## Table of Contents

1. [HTTP Status Code Reference](#http-status-code-reference)
2. [SQL State Mapping](#sql-state-mapping)
3. [Common Error Scenarios](#common-error-scenarios)
4. [Troubleshooting Decision Tree](#troubleshooting-decision-tree)
5. [Integration Best Practices](#integration-best-practices)
6. [Authentication & Authorization Errors](#authentication--authorization-errors)
7. [Data Validation Errors](#data-validation-errors)
8. [Business Logic Errors](#business-logic-errors)
9. [System & Infrastructure Errors](#system--infrastructure-errors)
10. [UAT Testing Error Scenarios](#uat-testing-error-scenarios)

---

## HTTP Status Code Reference

### 2xx Success Codes

| Code | Meaning    | When Used                      | Example Response                                |
| ---- | ---------- | ------------------------------ | ----------------------------------------------- |
| 200  | OK         | Successful GET, PUT operations | `{"data": {...}, "message": "Success"}`         |
| 201  | Created    | Successful POST operations     | `{"id": "uuid", "message": "Resource created"}` |
| 204  | No Content | Successful DELETE operations   | _(Empty response body)_                         |

### 4xx Client Error Codes

| Code | Meaning              | When Used                                | Recovery Action                         |
| ---- | -------------------- | ---------------------------------------- | --------------------------------------- |
| 400  | Bad Request          | Invalid input, validation failures       | Fix request data and retry              |
| 401  | Unauthorized         | Missing or invalid authentication        | Provide valid credentials               |
| 403  | Forbidden            | Insufficient permissions                 | Contact administrator for access        |
| 404  | Not Found            | Resource doesn't exist                   | Verify resource ID and availability     |
| 409  | Conflict             | Duplicate resource, constraint violation | Use different values or update existing |
| 422  | Unprocessable Entity | Business logic validation failure        | Fix business rule violations            |

### 5xx Server Error Codes

| Code | Meaning               | When Used                  | Recovery Action         |
| ---- | --------------------- | -------------------------- | ----------------------- |
| 500  | Internal Server Error | Unexpected system failure  | Report to support team  |
| 502  | Bad Gateway           | Database connection issues | Retry after brief delay |
| 503  | Service Unavailable   | System maintenance mode    | Wait and retry later    |

---

## SQL State Mapping

UMIG API implements specific SQL state to HTTP status mappings for database-related errors:

### Critical Mappings

```
SQL State 23503 → HTTP 400 (Foreign Key Constraint Violation)
SQL State 23505 → HTTP 409 (Unique Constraint Violation)
SQL State 42P01 → HTTP 500 (Table/Relation Does Not Exist)
SQL State 42703 → HTTP 500 (Column Does Not Exist)
SQL State 23502 → HTTP 400 (Not Null Constraint Violation)
```

### Example Error Response

```json
{
  "error": "Constraint violation",
  "message": "Referenced team ID does not exist",
  "details": {
    "field": "usr_id_lead",
    "value": 999,
    "code": "FOREIGN_KEY_VIOLATION",
    "sql_state": "23503",
    "suggestion": "Use a valid user ID from the users table"
  },
  "timestamp": "2025-08-18T16:47:00Z",
  "path": "/teams"
}
```

---

## Common Error Scenarios

### 1. Migration Creation Errors

#### Scenario: Missing Required Fields

```json
{
  "error": "Validation failed",
  "message": "Required field 'mig_name' is missing or empty",
  "details": {
    "field": "mig_name",
    "code": "REQUIRED_FIELD_MISSING",
    "suggestion": "Provide a non-empty migration name"
  },
  "timestamp": "2025-08-18T16:45:00Z",
  "path": "/migrations"
}
```

**Resolution**: Ensure all required fields are provided with valid values.

#### Scenario: Invalid Date Sequence

```json
{
  "error": "Business logic violation",
  "message": "End date must be after start date",
  "details": {
    "fields": ["mig_start_date", "mig_end_date"],
    "values": ["2025-10-15", "2025-09-01"],
    "code": "INVALID_DATE_SEQUENCE",
    "suggestion": "Ensure start_date < end_date < business_cutover_date"
  },
  "timestamp": "2025-08-18T16:48:00Z",
  "path": "/migrations"
}
```

**Resolution**: Correct date sequence to maintain logical chronological order.

### 2. Team Management Errors

#### Scenario: Invalid Team Lead Assignment

```json
{
  "error": "Constraint violation",
  "message": "Referenced user ID does not exist",
  "details": {
    "field": "usr_id_lead",
    "value": 999,
    "code": "FOREIGN_KEY_VIOLATION",
    "sql_state": "23503",
    "suggestion": "Use a valid user ID from the users table"
  },
  "timestamp": "2025-08-18T16:50:00Z",
  "path": "/teams"
}
```

**Resolution**: Verify user exists before assignment, use `/users` endpoint to get valid IDs.

#### Scenario: Duplicate Team Name

```json
{
  "error": "Resource conflict",
  "message": "Team with this name already exists",
  "details": {
    "field": "tm_name",
    "value": "Cloud Infrastructure Team",
    "code": "UNIQUE_CONSTRAINT_VIOLATION",
    "sql_state": "23505",
    "suggestion": "Use a different team name or update the existing team"
  },
  "timestamp": "2025-08-18T16:52:00Z",
  "path": "/teams"
}
```

**Resolution**: Choose unique team name or update existing team record.

### 3. Step Management Errors

#### Scenario: Bulk Update Partial Failure

```json
{
  "error": "Partial operation failure",
  "message": "3 out of 5 step updates failed",
  "details": {
    "successful_updates": 2,
    "failed_updates": 3,
    "failures": [
      {
        "step_id": "step_003",
        "error": "Step not found",
        "code": "RESOURCE_NOT_FOUND"
      },
      {
        "step_id": "step_004",
        "error": "Invalid status transition",
        "code": "INVALID_STATUS_TRANSITION"
      },
      {
        "step_id": "step_005",
        "error": "Permission denied",
        "code": "INSUFFICIENT_PERMISSIONS"
      }
    ],
    "suggestion": "Review failed items and correct issues before retrying"
  },
  "timestamp": "2025-08-18T16:55:00Z",
  "path": "/steps/bulk/update"
}
```

**Resolution**: Address each failure individually and retry bulk operation.

---

## Troubleshooting Decision Tree

### Step 1: Identify Error Category

```
Is HTTP status 4xx?
├─ YES → Client Error (Continue to Step 2)
└─ NO → Server Error (Contact Support)

Is HTTP status 5xx?
├─ YES → System Error (Check system status, retry once)
└─ NO → Check for 2xx success codes
```

### Step 2: Client Error Analysis

```
HTTP 400 Bad Request?
├─ Check "details.code" field
├─ VALIDATION_FAILED → Fix input data
├─ FOREIGN_KEY_VIOLATION → Verify referenced IDs
├─ NOT_NULL_CONSTRAINT → Provide required fields
└─ INVALID_FORMAT → Check data types and formats

HTTP 401 Unauthorized?
├─ Missing Authorization header → Add HTTP Basic Auth
├─ Invalid credentials → Verify username/password
└─ Expired session → Re-authenticate

HTTP 403 Forbidden?
├─ Check user role requirements
├─ Contact administrator for permissions
└─ Verify resource ownership

HTTP 404 Not Found?
├─ Verify resource ID format (UUID)
├─ Check resource exists via list endpoint
└─ Confirm correct API endpoint path

HTTP 409 Conflict?
├─ UNIQUE_CONSTRAINT → Use different values
├─ CONCURRENT_MODIFICATION → Refresh data and retry
└─ BUSINESS_RULE_VIOLATION → Check business logic
```

### Step 3: Resolution Actions

```
Validation Error?
├─ Review API documentation for field requirements
├─ Check example requests for proper format
├─ Validate data types and constraints
└─ Test with minimal valid payload

Constraint Error?
├─ Use list endpoints to find valid reference IDs
├─ Check foreign key relationships
├─ Verify unique field constraints
└─ Review database schema if available

Permission Error?
├─ Confirm user has required Confluence group membership
├─ Check "confluence-users" group assignment
├─ Contact administrator for elevated permissions
└─ Verify API endpoint access requirements
```

---

## Authentication & Authorization Errors

### Authentication Required (401)

```json
{
  "error": "Authentication required",
  "message": "Valid credentials must be provided",
  "details": {
    "code": "AUTHENTICATION_REQUIRED",
    "suggestion": "Include HTTP Basic Authentication headers"
  },
  "timestamp": "2025-08-18T16:52:00Z",
  "path": "/steps"
}
```

**Resolution Steps**:

1. Add Authorization header: `Authorization: Basic <base64-encoded-credentials>`
2. For admin access: Configure credentials via environment variable `UMIG_AUTH_CREDENTIALS`
3. Verify Confluence server authentication settings

### Insufficient Permissions (403)

```json
{
  "error": "Insufficient permissions",
  "message": "User does not have permission to modify this resource",
  "details": {
    "required_role": "confluence-administrators",
    "user_role": "confluence-users",
    "code": "INSUFFICIENT_PERMISSIONS",
    "suggestion": "Contact administrator for elevated permissions"
  },
  "timestamp": "2025-08-18T16:55:00Z",
  "path": "/migrations/bulk/delete"
}
```

**Resolution Steps**:

1. Check user group membership in Confluence
2. Request administrator to add user to required groups
3. Verify endpoint-specific permission requirements
4. Use appropriate user account for testing

---

## Data Validation Errors

### Required Field Validation

```json
{
  "error": "Validation failed",
  "message": "Multiple required fields missing",
  "details": {
    "missing_fields": ["mig_name", "mig_start_date"],
    "code": "REQUIRED_FIELDS_MISSING",
    "suggestion": "Provide all required fields before submitting"
  },
  "timestamp": "2025-08-18T17:00:00Z",
  "path": "/migrations"
}
```

### Format Validation

```json
{
  "error": "Validation failed",
  "message": "Invalid date format provided",
  "details": {
    "field": "mig_start_date",
    "value": "18/08/2025",
    "expected_format": "YYYY-MM-DD",
    "code": "INVALID_DATE_FORMAT",
    "suggestion": "Use ISO date format: 2025-08-18"
  },
  "timestamp": "2025-08-18T17:02:00Z",
  "path": "/migrations"
}
```

### Length Validation

```json
{
  "error": "Validation failed",
  "message": "Field value exceeds maximum length",
  "details": {
    "field": "mig_description",
    "current_length": 1024,
    "max_length": 500,
    "code": "FIELD_TOO_LONG",
    "suggestion": "Reduce description to 500 characters or less"
  },
  "timestamp": "2025-08-18T17:05:00Z",
  "path": "/migrations"
}
```

---

## Business Logic Errors

### Status Transition Errors

```json
{
  "error": "Business logic violation",
  "message": "Invalid status transition attempted",
  "details": {
    "current_status": 3,
    "requested_status": 1,
    "current_label": "Completed",
    "requested_label": "Planning",
    "code": "INVALID_STATUS_TRANSITION",
    "suggestion": "Status can only progress forward or move to Failed (4)"
  },
  "timestamp": "2025-08-18T17:08:00Z",
  "path": "/steps/step_001"
}
```

### Dependency Validation

```json
{
  "error": "Business logic violation",
  "message": "Cannot delete migration with active iterations",
  "details": {
    "migration_id": "6ba7b810-9dad-11d1-80b4-00c04fd430c8",
    "active_iterations": 2,
    "code": "DEPENDENCY_CONSTRAINT",
    "suggestion": "Complete or delete all iterations before deleting migration"
  },
  "timestamp": "2025-08-18T17:10:00Z",
  "path": "/migrations/6ba7b810-9dad-11d1-80b4-00c04fd430c8"
}
```

---

## System & Infrastructure Errors

### Database Connection Errors

```json
{
  "error": "Database connection failed",
  "message": "Unable to connect to PostgreSQL database",
  "details": {
    "code": "DATABASE_CONNECTION_ERROR",
    "suggestion": "Check database server status and retry"
  },
  "timestamp": "2025-08-18T17:15:00Z",
  "path": "/steps"
}
```

**Resolution Steps**:

1. Verify PostgreSQL container is running: `docker ps`
2. Check database logs: `docker logs umig-postgres`
3. Test database connectivity: `psql -h localhost -U umig_user -d umig_db`
4. Restart database if needed: `npm run restart:erase`

### ScriptRunner Integration Errors

```json
{
  "error": "ScriptRunner execution failed",
  "message": "Groovy script compilation error",
  "details": {
    "script_path": "/api/v2/steps",
    "compilation_error": "Syntax error at line 45",
    "code": "SCRIPT_COMPILATION_ERROR",
    "suggestion": "Check Groovy script syntax and ScriptRunner configuration"
  },
  "timestamp": "2025-08-18T17:18:00Z",
  "path": "/steps"
}
```

**Resolution Steps**:

1. Check ScriptRunner logs in Confluence administration
2. Verify Groovy script syntax in ScriptRunner console
3. Test script compilation with simplified payload
4. Contact development team if persistent

---

## UAT Testing Error Scenarios

### Test Scenario 1: Authentication Testing

```bash
# Test 1: No authentication
curl -X GET http://localhost:8090/rest/scriptrunner/latest/custom/umig/migrations
# Expected: 401 Unauthorized

# Test 2: Invalid credentials
curl -X GET http://localhost:8090/rest/scriptrunner/latest/custom/umig/migrations \
  -H "Authorization: Basic aW52YWxpZDppbnZhbGlk"
# Expected: 401 Unauthorized

# Test 3: Valid credentials
curl -X GET http://localhost:8090/rest/scriptrunner/latest/custom/umig/migrations \
  -H "Authorization: Basic $(echo -n ${UMIG_AUTH_CREDENTIALS:-admin:admin} | base64)"
# Expected: 200 OK with migration list
```

### Test Scenario 2: Validation Testing

```bash
# Test 1: Missing required fields
curl -X POST http://localhost:8090/rest/scriptrunner/latest/custom/umig/migrations \
  -H "Authorization: Basic $(echo -n ${UMIG_AUTH_CREDENTIALS:-admin:admin} | base64)" \
  -H "Content-Type: application/json" \
  -d '{}'
# Expected: 400 Bad Request with validation errors

# Test 2: Invalid data formats
curl -X POST http://localhost:8090/rest/scriptrunner/latest/custom/umig/migrations \
  -H "Authorization: Basic $(echo -n ${UMIG_AUTH_CREDENTIALS:-admin:admin} | base64)" \
  -H "Content-Type: application/json" \
  -d '{"mig_name": "Test", "mig_start_date": "invalid-date"}'
# Expected: 400 Bad Request with format error

# Test 3: Valid data
curl -X POST http://localhost:8090/rest/scriptrunner/latest/custom/umig/migrations \
  -H "Authorization: Basic $(echo -n ${UMIG_AUTH_CREDENTIALS:-admin:admin} | base64)" \
  -H "Content-Type: application/json" \
  -d '{"mig_name": "UAT Test Migration", "mig_start_date": "2025-09-01"}'
# Expected: 201 Created with migration details
```

### Test Scenario 3: Error Recovery Testing

```bash
# Test 1: Create resource to test conflict
curl -X POST http://localhost:8090/rest/scriptrunner/latest/custom/umig/teams \
  -H "Authorization: Basic $(echo -n ${UMIG_AUTH_CREDENTIALS:-admin:admin} | base64)" \
  -H "Content-Type: application/json" \
  -d '{"tm_name": "Test Team", "tm_description": "Test Description"}'

# Test 2: Attempt duplicate creation
curl -X POST http://localhost:8090/rest/scriptrunner/latest/custom/umig/teams \
  -H "Authorization: Basic $(echo -n ${UMIG_AUTH_CREDENTIALS:-admin:admin} | base64)" \
  -H "Content-Type: application/json" \
  -d '{"tm_name": "Test Team", "tm_description": "Duplicate Test"}'
# Expected: 409 Conflict with unique constraint error

# Test 3: Recovery with different name
curl -X POST http://localhost:8090/rest/scriptrunner/latest/custom/umig/teams \
  -H "Authorization: Basic $(echo -n ${UMIG_AUTH_CREDENTIALS:-admin:admin} | base64)" \
  -H "Content-Type: application/json" \
  -d '{"tm_name": "Test Team 2", "tm_description": "Updated Test"}'
# Expected: 201 Created with new team details
```

---

## Integration Best Practices

### 1. Error Handling Strategy

```javascript
// Recommended error handling pattern
async function callUmigApi(endpoint, options) {
  try {
    const response = await fetch(endpoint, {
      ...options,
      headers: {
        Authorization: `Basic ${btoa(process.env.UMIG_AUTH_CREDENTIALS || 'admin:admin')}`,
        "Content-Type": "application/json",
        ...options.headers,
      },
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new UmigApiError(response.status, errorData);
    }

    return await response.json();
  } catch (error) {
    if (error instanceof UmigApiError) {
      // Handle specific API errors
      handleApiError(error);
    } else {
      // Handle network/system errors
      handleSystemError(error);
    }
    throw error;
  }
}

class UmigApiError extends Error {
  constructor(status, errorData) {
    super(errorData.message);
    this.status = status;
    this.details = errorData.details;
    this.code = errorData.details?.code;
    this.suggestion = errorData.details?.suggestion;
  }
}
```

### 2. Retry Logic Implementation

```javascript
async function apiCallWithRetry(endpoint, options, maxRetries = 3) {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return await callUmigApi(endpoint, options);
    } catch (error) {
      // Retry on 5xx errors, but not on 4xx client errors
      if (error.status >= 500 && attempt < maxRetries) {
        const delay = Math.pow(2, attempt) * 1000; // Exponential backoff
        await new Promise((resolve) => setTimeout(resolve, delay));
        continue;
      }
      throw error;
    }
  }
}
```

### 3. Validation Before API Calls

```javascript
function validateMigrationData(migration) {
  const errors = [];

  if (!migration.mig_name || migration.mig_name.trim() === "") {
    errors.push("Migration name is required");
  }

  if (migration.mig_start_date && migration.mig_end_date) {
    if (
      new Date(migration.mig_start_date) >= new Date(migration.mig_end_date)
    ) {
      errors.push("End date must be after start date");
    }
  }

  if (errors.length > 0) {
    throw new ValidationError(errors);
  }
}
```

---

## Support and Escalation

### When to Contact Support

- **Persistent 500 errors**: System-level issues requiring infrastructure attention
- **Authentication configuration issues**: ScriptRunner or Confluence setup problems
- **Database connectivity problems**: PostgreSQL connection or configuration issues
- **Performance degradation**: Response times exceeding 10 seconds consistently

### Information to Provide

1. **Complete error response**: Full JSON error message
2. **Request details**: HTTP method, endpoint, headers, body
3. **Timestamp**: Exact time of error occurrence
4. **Environment details**: Local development, test, or production
5. **Reproduction steps**: Minimal steps to reproduce the issue

### Contact Information

- **Development Team**: UMIG Sprint 5 team
- **System Administrator**: Confluence/ScriptRunner support
- **Database Team**: PostgreSQL administration
- **Priority**: P0 Critical for UAT-blocking issues

---

## Appendix: Quick Reference

### Common HTTP Status Codes

- `200` - Success (GET, PUT)
- `201` - Created (POST)
- `204` - No Content (DELETE)
- `400` - Bad Request (validation, constraints)
- `401` - Unauthorized (authentication required)
- `403` - Forbidden (insufficient permissions)
- `404` - Not Found (resource doesn't exist)
- `409` - Conflict (duplicate, constraint violation)
- `500` - Internal Server Error (system failure)

### Key SQL State Mappings

- `23503` → `400` (Foreign key violation)
- `23505` → `409` (Unique constraint violation)
- `23502` → `400` (Not null constraint violation)

### Authentication Header

```
Authorization: Basic $(echo -n ${UMIG_AUTH_CREDENTIALS:-admin:admin} | base64)
```

### Error Response Format

```json
{
  "error": "Error category",
  "message": "Human-readable description",
  "details": {
    "code": "MACHINE_READABLE_CODE",
    "field": "field_name",
    "value": "problematic_value",
    "suggestion": "How to fix this"
  },
  "timestamp": "2025-08-18T17:00:00Z",
  "path": "/api/endpoint"
}
```

---

**Document Version**: 1.0  
**Last Updated**: August 18, 2025  
**Sprint**: 5 (US-030)  
**Status**: UAT Ready  
**Next Review**: Post-UAT feedback integration
