<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="x-apple-disable-message-reformatting">
    <meta name="format-detection" content="telephone=no,address=no,email=no,date=no,url=no">
    
    <title>${stepInstance.sti_code ?: 'STEP'} - ${stepInstance.sti_name ?: 'Step Details'} | UMIG</title>
    
    <!--[if mso]>
    <noscript>
        <xml>
            <o:OfficeDocumentSettings>
                <o:AllowPNG/>
                <o:PixelsPerInch>96</o:PixelsPerInch>
            </o:OfficeDocumentSettings>
        </xml>
    </noscript>
    <![endif]-->
    
    <style>
        /* EMAIL CLIENT COMPATIBILITY RESET */
        html, body, table, tbody, tr, td, div, p, ul, ol, li, h1, h2, h3, h4, h5, h6 {
            margin: 0 !important;
            padding: 0 !important;
            border: 0 !important;
        }
        
        /* UNIVERSAL STYLES */
        * {
            font-family: 'Segoe UI', system-ui, -apple-system, 'Helvetica Neue', Arial, sans-serif !important;
        }
        
        body {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            min-width: 100% !important;
            -webkit-text-size-adjust: 100% !important;
            -ms-text-size-adjust: 100% !important;
            -webkit-font-smoothing: antialiased !important;
            background-color: #f8f9fa !important;
            color: #212529 !important;
        }
        
        /* TABLE RESETS FOR OUTLOOK */
        table, td {
            mso-table-lspace: 0pt !important;
            mso-table-rspace: 0pt !important;
            border-collapse: collapse !important;
        }
        
        /* IMAGE HANDLING */
        img {
            -ms-interpolation-mode: bicubic !important;
            border: 0 !important;
            outline: none !important;
            text-decoration: none !important;
            display: block !important;
        }
        
        /* CONTAINER STRUCTURE */
        .email-wrapper {
            width: 100% !important;
            background-color: #f8f9fa !important;
            padding: 20px 0 !important;
        }
        
        .email-container {
            max-width: 600px !important;
            margin: 0 auto !important;
            background-color: #ffffff !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1) !important;
            overflow: hidden !important;
        }
        
        /* HEADER SECTION */
        .email-header {
            background: linear-gradient(135deg, #0052CC 0%, #0065FF 100%) !important;
            color: #ffffff !important;
            padding: 32px 24px !important;
            text-align: center !important;
        }
        
        .header-title {
            font-size: 28px !important;
            font-weight: 700 !important;
            line-height: 1.2 !important;
            margin: 0 0 12px 0 !important;
            color: #ffffff !important;
        }
        
        .header-breadcrumb {
            font-size: 16px !important;
            opacity: 0.9 !important;
            line-height: 1.4 !important;
            color: #ffffff !important;
            margin: 12px 0 !important;
        }
        
        .header-meta {
            font-size: 14px !important;
            opacity: 0.8 !important;
            margin-top: 16px !important;
            padding-top: 16px !important;
            border-top: 1px solid rgba(255,255,255,0.2) !important;
            color: #ffffff !important;
        }
        
        /* CONTENT SECTIONS */
        .email-content {
            padding: 32px 24px !important;
        }
        
        .content-section {
            margin-bottom: 32px !important;
        }
        
        .content-section:last-child {
            margin-bottom: 0 !important;
        }
        
        /* STEP DETAILS CARD */
        .step-details-card {
            background-color: #f8f9fa !important;
            border: 1px solid #e9ecef !important;
            border-radius: 8px !important;
            padding: 24px !important;
            margin: 24px 0 !important;
        }
        
        .section-title {
            font-size: 20px !important;
            font-weight: 600 !important;
            color: #212529 !important;
            margin: 0 0 16px 0 !important;
            line-height: 1.3 !important;
        }
        
        /* METADATA GRID */
        .metadata-grid {
            width: 100% !important;
        }
        
        .metadata-row {
            border-bottom: 1px solid #e9ecef !important;
            padding: 12px 0 !important;
        }
        
        .metadata-row:last-child {
            border-bottom: none !important;
        }
        
        .metadata-label {
            font-weight: 600 !important;
            color: #6c757d !important;
            font-size: 14px !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
            margin-bottom: 4px !important;
        }
        
        .metadata-value {
            font-size: 16px !important;
            color: #212529 !important;
            line-height: 1.4 !important;
            word-wrap: break-word !important;
        }
        
        /* STATUS BADGES */
        .status-badge {
            display: inline-block !important;
            padding: 8px 16px !important;
            border-radius: 20px !important;
            font-weight: 600 !important;
            font-size: 14px !important;
            color: #ffffff !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
        }
        
        .status-open { background-color: #17a2b8 !important; }
        .status-in-progress { background-color: #fd7e14 !important; }
        .status-completed { background-color: #28a745 !important; }
        .status-blocked { background-color: #dc3545 !important; }
        .status-cancelled { background-color: #6c757d !important; }
        
        /* INSTRUCTIONS SECTION */
        .instructions-container {
            background-color: #ffffff !important;
            border: 1px solid #e9ecef !important;
            border-radius: 8px !important;
            overflow: hidden !important;
        }
        
        .instructions-header {
            background-color: #f8f9fa !important;
            padding: 16px 20px !important;
            font-weight: 600 !important;
            font-size: 16px !important;
            color: #495057 !important;
            border-bottom: 1px solid #e9ecef !important;
        }
        
        .instruction-item {
            padding: 16px 20px !important;
            border-bottom: 1px solid #f1f3f4 !important;
            display: flex !important;
            align-items: flex-start !important;
        }
        
        .instruction-item:last-child {
            border-bottom: none !important;
        }
        
        .instruction-status {
            width: 24px !important;
            height: 24px !important;
            border-radius: 50% !important;
            margin-right: 12px !important;
            flex-shrink: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 14px !important;
            font-weight: bold !important;
        }
        
        .instruction-complete {
            background-color: #28a745 !important;
            color: #ffffff !important;
        }
        
        .instruction-pending {
            background-color: #e9ecef !important;
            color: #6c757d !important;
        }
        
        .instruction-text {
            flex: 1 !important;
            font-size: 15px !important;
            line-height: 1.4 !important;
            color: #212529 !important;
        }
        
        .instruction-completed-text {
            text-decoration: line-through !important;
            opacity: 0.6 !important;
        }
        
        /* CTA BUTTON */
        .cta-container {
            text-align: center !important;
            margin: 32px 0 !important;
            padding: 24px !important;
            background-color: #f8f9fa !important;
            border-radius: 8px !important;
        }
        
        .cta-button {
            display: inline-block !important;
            padding: 16px 32px !important;
            background-color: #007bff !important;
            color: #ffffff !important;
            text-decoration: none !important;
            border-radius: 8px !important;
            font-weight: 600 !important;
            font-size: 16px !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
            min-height: 44px !important;
            min-width: 200px !important;
            box-sizing: border-box !important;
        }
        
        .cta-button:hover {
            background-color: #0056b3 !important;
            color: #ffffff !important;
            text-decoration: none !important;
        }
        
        .cta-subtitle {
            font-size: 14px !important;
            color: #6c757d !important;
            margin-top: 12px !important;
            line-height: 1.4 !important;
        }
        
        /* DESCRIPTION BOX */
        .description-box {
            background-color: #ffffff !important;
            border: 1px solid #e9ecef !important;
            border-radius: 6px !important;
            padding: 20px !important;
            margin: 16px 0 !important;
            line-height: 1.6 !important;
            color: #212529 !important;
            font-size: 15px !important;
        }
        
        /* FOOTER */
        .email-footer {
            background-color: #f8f9fa !important;
            border-top: 1px solid #e9ecef !important;
            padding: 32px 24px !important;
            text-align: center !important;
            color: #6c757d !important;
            font-size: 14px !important;
            line-height: 1.5 !important;
        }
        
        .footer-brand {
            font-weight: 600 !important;
            color: #212529 !important;
            margin-bottom: 16px !important;
        }
        
        .footer-links {
            margin: 20px 0 !important;
        }
        
        .footer-link {
            color: #007bff !important;
            text-decoration: none !important;
            margin: 0 16px !important;
            font-weight: 500 !important;
        }
        
        .footer-link:hover {
            color: #0056b3 !important;
        }
        
        .footer-disclaimer {
            font-size: 12px !important;
            color: #6c757d !important;
            margin-top: 20px !important;
            padding-top: 20px !important;
            border-top: 1px solid #e9ecef !important;
            line-height: 1.4 !important;
        }
        
        /* MOBILE RESPONSIVE DESIGN */
        @media screen and (max-width: 600px) {
            .email-wrapper {
                padding: 10px 0 !important;
            }
            
            .email-container {
                margin: 0 10px !important;
                border-radius: 4px !important;
            }
            
            .email-header {
                padding: 24px 20px !important;
            }
            
            .header-title {
                font-size: 24px !important;
            }
            
            .header-breadcrumb {
                font-size: 14px !important;
            }
            
            .email-content {
                padding: 24px 20px !important;
            }
            
            .step-details-card {
                padding: 20px !important;
                margin: 20px 0 !important;
            }
            
            .section-title {
                font-size: 18px !important;
            }
            
            .metadata-row {
                padding: 10px 0 !important;
            }
            
            .instruction-item {
                padding: 12px 16px !important;
            }
            
            .instruction-text {
                font-size: 14px !important;
            }
            
            .cta-container {
                padding: 20px !important;
                margin: 24px 0 !important;
            }
            
            .cta-button {
                padding: 14px 28px !important;
                font-size: 15px !important;
                min-width: 160px !important;
                width: 80% !important;
                max-width: 280px !important;
            }
            
            .email-footer {
                padding: 24px 20px !important;
            }
            
            .footer-link {
                display: block !important;
                margin: 8px 0 !important;
            }
        }
        
        /* SMALL MOBILE (320px) */
        @media screen and (max-width: 480px) {
            .email-container {
                margin: 0 5px !important;
            }
            
            .header-title {
                font-size: 22px !important;
                line-height: 1.1 !important;
            }
            
            .email-content {
                padding: 20px 16px !important;
            }
            
            .step-details-card {
                padding: 16px !important;
            }
            
            .metadata-value {
                font-size: 15px !important;
            }
            
            .instruction-item {
                padding: 10px 12px !important;
            }
            
            .cta-button {
                width: 90% !important;
                padding: 12px 20px !important;
            }
        }
        
        /* DARK MODE SUPPORT */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1a1a1a !important;
            }
            
            .email-wrapper {
                background-color: #1a1a1a !important;
            }
            
            .email-container {
                background-color: #2d2d2d !important;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3) !important;
            }
            
            .step-details-card {
                background-color: #3a3a3a !important;
                border-color: #4a4a4a !important;
            }
            
            .section-title,
            .metadata-value,
            .instruction-text {
                color: #ffffff !important;
            }
            
            .metadata-label {
                color: #cccccc !important;
            }
            
            .instructions-container {
                background-color: #2d2d2d !important;
                border-color: #4a4a4a !important;
            }
            
            .instructions-header {
                background-color: #3a3a3a !important;
                color: #ffffff !important;
                border-color: #4a4a4a !important;
            }
            
            .instruction-item {
                border-color: #4a4a4a !important;
            }
            
            .description-box {
                background-color: #2d2d2d !important;
                border-color: #4a4a4a !important;
                color: #ffffff !important;
            }
            
            .cta-container {
                background-color: #3a3a3a !important;
            }
            
            .email-footer {
                background-color: #3a3a3a !important;
                border-color: #4a4a4a !important;
                color: #cccccc !important;
            }
            
            .footer-brand {
                color: #ffffff !important;
            }
        }
        
        /* PRINT STYLES */
        @media print {
            body {
                background-color: #ffffff !important;
            }
            
            .email-wrapper {
                background-color: #ffffff !important;
                padding: 0 !important;
            }
            
            .email-container {
                box-shadow: none !important;
                border: 1px solid #000000 !important;
                max-width: none !important;
            }
            
            .email-header {
                background: #ffffff !important;
                color: #000000 !important;
                border-bottom: 2px solid #000000 !important;
            }
            
            .header-title,
            .header-breadcrumb,
            .header-meta {
                color: #000000 !important;
            }
            
            .status-badge {
                background-color: #000000 !important;
                color: #ffffff !important;
                border: 1px solid #000000 !important;
            }
            
            .cta-button {
                background-color: #000000 !important;
                color: #ffffff !important;
                border: 2px solid #000000 !important;
            }
        }
        
        /* OUTLOOK-SPECIFIC FIXES */
        <!--[if mso]>
        .email-container {
            width: 600px !important;
        }
        
        .status-badge {
            border: 1px solid #000000 !important;
        }
        
        .cta-button {
            border: 1px solid #007bff !important;
        }
        
        table {
            border-collapse: collapse !important;
        }
        <![endif]-->
    </style>
    
    <!--[if mso]>
    <style type="text/css">
        .email-header {
            background: #0052cc !important;
        }
        
        table, td {
            border-collapse: collapse !important;
        }
        
        .instructions-container {
            border-spacing: 0 !important;
        }
        
        .instruction-item {
            display: block !important;
            width: 100% !important;
        }
    </style>
    <![endif]-->
</head>
<body role="article" aria-label="UMIG Step Details Email">
    <div role="main">
        <!-- Email Wrapper -->
        <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" class="email-wrapper">
            <tr>
                <td align="center" valign="top">
                    <!-- Email Container -->
                    <div class="email-container">
                        <!-- Header Section -->
                        <div class="email-header">
                            <h1 class="header-title">
                                📋 ${stepInstance.sti_code ?: 'STEP'} - ${stepInstance.sti_name ?: 'Step Details'}
                            </h1>
                            <div class="header-breadcrumb">
                                <% if (migrationCode && iterationCode) { %>
                                ${migrationCode} › ${iterationCode}
                                <% if (stepInstance.plan_name) { %> › ${stepInstance.plan_name}<% } %>
                                <% if (stepInstance.sequence_name) { %> › ${stepInstance.sequence_name}<% } %>
                                <% if (stepInstance.phase_name) { %> › ${stepInstance.phase_name}<% } %>
                                <% } else { %>
                                ${stepInstance.migration_name ?: 'Migration'} › ${stepInstance.iteration_name ?: 'Iteration'}
                                <% } %>
                            </div>
                            <div class="header-meta">
                                Generated on ${new Date().format('MMM dd, yyyy')} at ${new Date().format('HH:mm')}
                                <% if (changedBy) { %> by ${changedBy}<% } %>
                                <br>
                                <small>Complete step details for offline viewing</small>
                            </div>
                        </div>
                        
                        <!-- Content Section -->
                        <div class="email-content">
                            <!-- Step Details Card -->
                            <div class="content-section">
                                <div class="step-details-card">
                                    <h2 class="section-title">📊 Step Summary</h2>
                                    <table class="metadata-grid" cellspacing="0" cellpadding="0" border="0" width="100%">
                                        <tr>
                                            <td class="metadata-row">
                                                <div class="metadata-label">Status</div>
                                                <div class="metadata-value">
                                                    <span class="status-badge status-${(stepInstance.sti_status ?: 'open').toLowerCase().replace('_', '-')}">
                                                        ${stepInstance.sti_status ?: 'OPEN'}
                                                    </span>
                                                    <% if (oldStatus && newStatus && oldStatus != newStatus) { %>
                                                    <br><small style="color: #6c757d; margin-top: 4px;">Changed from ${oldStatus} → ${newStatus}</small>
                                                    <% } %>
                                                </div>
                                            </td>
                                        </tr>
                                        <% if (stepInstance.sti_duration_minutes) { %>
                                        <tr>
                                            <td class="metadata-row">
                                                <div class="metadata-label">Duration</div>
                                                <div class="metadata-value">
                                                    ${stepInstance.sti_duration_minutes} minute${stepInstance.sti_duration_minutes == 1 ? '' : 's'}
                                                </div>
                                            </td>
                                        </tr>
                                        <% } %>
                                        <% if (stepInstance.team_name) { %>
                                        <tr>
                                            <td class="metadata-row">
                                                <div class="metadata-label">Assigned Team</div>
                                                <div class="metadata-value">${stepInstance.team_name}</div>
                                            </td>
                                        </tr>
                                        <% } %>
                                        <% if (stepInstance.environment_name) { %>
                                        <tr>
                                            <td class="metadata-row">
                                                <div class="metadata-label">Environment</div>
                                                <div class="metadata-value">${stepInstance.environment_name}</div>
                                            </td>
                                        </tr>
                                        <% } %>
                                        <% if (stepInstance.predecessor_code) { %>
                                        <tr>
                                            <td class="metadata-row">
                                                <div class="metadata-label">Predecessor</div>
                                                <div class="metadata-value">
                                                    ${stepInstance.predecessor_code}
                                                    <% if (stepInstance.predecessor_name) { %>: ${stepInstance.predecessor_name}<% } %>
                                                </div>
                                            </td>
                                        </tr>
                                        <% } %>
                                        <% if (changedAt) { %>
                                        <tr>
                                            <td class="metadata-row">
                                                <div class="metadata-label">Last Updated</div>
                                                <div class="metadata-value">${changedAt}</div>
                                            </td>
                                        </tr>
                                        <% } %>
                                    </table>
                                    
                                    <!-- Description -->
                                    <% if (stepInstance.sti_description) { %>
                                    <div class="metadata-label" style="margin-top: 20px;">Description</div>
                                    <div class="description-box">
                                        ${stepInstance.sti_description}
                                    </div>
                                    <% } %>
                                </div>
                            </div>
                            
                            <!-- Instructions Section -->
                            <div class="content-section">
                                <h2 class="section-title">📝 Instructions</h2>
                                <% if (stepInstance.instructions && stepInstance.instructions.size() > 0) { %>
                                <div class="instructions-container">
                                    <div class="instructions-header">
                                        ${stepInstance.instructions.size()} instruction${stepInstance.instructions.size() == 1 ? '' : 's'}
                                    </div>
                                    <% stepInstance.instructions.eachWithIndex { instruction, index -> %>
                                    <div class="instruction-item">
                                        <div class="instruction-status ${instruction.completed ? 'instruction-complete' : 'instruction-pending'}">
                                            ${instruction.completed ? '✓' : (index + 1)}
                                        </div>
                                        <div class="instruction-text ${instruction.completed ? 'instruction-completed-text' : ''}">
                                            ${instruction.ini_name ?: instruction.description ?: "Instruction ${index + 1}"}
                                            <% if (instruction.ini_duration_minutes) { %>
                                            <br><small style="color: #6c757d;">${instruction.ini_duration_minutes} min</small>
                                            <% } %>
                                        </div>
                                    </div>
                                    <% } %>
                                </div>
                                <% } else { %>
                                <div class="description-box">
                                    <p style="text-align: center; color: #6c757d; font-style: italic;">
                                        No instructions defined for this step.
                                    </p>
                                </div>
                                <% } %>
                            </div>
                            
                            <!-- Call-to-Action Button -->
                            <div class="content-section">
                                <div class="cta-container">
                                    <% if (hasStepViewUrl && stepViewUrl) { %>
                                    <a href="${stepViewUrl}" class="cta-button">
                                        🔗 View in Confluence
                                    </a>
                                    <div class="cta-subtitle">
                                        Click to view this step with live updates and collaboration features
                                    </div>
                                    <% } else { %>
                                    <div style="padding: 20px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; text-align: left;">
                                        <strong>📌 Access Information:</strong><br>
                                        Direct link is not available. Please access the UMIG system in Confluence to view the most current step details and collaborate with your team.
                                    </div>
                                    <% } %>
                                </div>
                            </div>
                            
                            <!-- Additional Context -->
                            <% if (newStatus && newStatus.toUpperCase() in ['COMPLETED', 'BLOCKED', 'IN_PROGRESS']) { %>
                            <div class="content-section">
                                <div class="step-details-card">
                                    <h3 class="section-title">💡 Next Steps</h3>
                                    <div class="description-box">
                                        <% if (newStatus.toUpperCase() == 'COMPLETED') { %>
                                        <p><strong>✅ Step Complete:</strong> This step has been successfully completed. Please verify all deliverables are in place and notify dependent teams as needed.</p>
                                        <% } else if (newStatus.toUpperCase() == 'BLOCKED') { %>
                                        <p><strong>⚠️ Attention Required:</strong> This step is currently blocked. Please review blocking issues and coordinate with relevant teams to resolve them promptly.</p>
                                        <% } else if (newStatus.toUpperCase() == 'IN_PROGRESS') { %>
                                        <p><strong>🔄 Work in Progress:</strong> Execution is now actively underway. Monitor progress, provide support as needed, and update stakeholders on key milestones.</p>
                                        <% } %>
                                        
                                        <p><strong>Recommended Actions:</strong></p>
                                        <ul style="margin: 12px 0; padding-left: 20px;">
                                            <li>Review step details and current status</li>
                                            <li>Check for dependent steps or teams affected</li>
                                            <li>Update project stakeholders as appropriate</li>
                                            <li>Document any issues or lessons learned</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <% } %>
                        </div>
                        
                        <!-- Footer -->
                        <div class="email-footer">
                            <div class="footer-brand">
                                <strong>UMIG - Unified Migration Implementation Guide</strong>
                            </div>
                            
                            <div class="footer-links">
                                <% if (hasStepViewUrl && stepViewUrl) { %>
                                <a href="${stepViewUrl}" class="footer-link">View Step Details</a>
                                <% } %>
                                <a href="#" class="footer-link">Help & Support</a>
                                <a href="#" class="footer-link">Project Dashboard</a>
                            </div>
                            
                            <div style="font-size: 14px; color: #495057; margin: 16px 0;">
                                This step is part of the <strong>${migrationCode ?: 'current migration'}</strong> project.
                                <br>
                                For questions or technical support, please contact your project coordinator.
                            </div>
                            
                            <div class="footer-disclaimer">
                                <strong>Important:</strong> This email contains a snapshot of step details as of ${new Date().format('MMM dd, yyyy HH:mm')}. 
                                For the most current information and real-time collaboration, please visit the live system in Confluence.
                                This email is intended for authorized project team members and stakeholders only.
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
        </table>
    </div>
</body>
</html>