{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://umig.internal/dto/schemas/StepInstanceDTO.schema.json",
  "title": "Step Data Transfer Object Schema",
  "description": "Comprehensive JSON schema for UMIG StepInstanceDTO validation (US-056-A Service Layer Standardization)",
  "type": "object",
  "additionalProperties": false,
  "required": ["stepId", "stepName", "stepStatus"],
  "properties": {
    "stepId": {
      "type": "string",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$",
      "description": "Primary step identifier in UUID format"
    },
    "stepInstanceId": {
      "type": ["string", "null"],
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$",
      "description": "Step instance identifier for specific executions"
    },
    "stepName": {
      "type": "string",
      "minLength": 1,
      "maxLength": 255,
      "description": "Human-readable step name (required)"
    },
    "stepDescription": {
      "type": ["string", "null"],
      "maxLength": 2000,
      "description": "Detailed step description"
    },
    "stepStatus": {
      "type": "string",
      "enum": ["PENDING", "IN_PROGRESS", "COMPLETED", "FAILED", "CANCELLED"],
      "description": "Current step status (required enumeration)"
    },
    "assignedTeamId": {
      "type": ["string", "null"],
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$",
      "description": "Assigned team identifier in UUID format"
    },
    "assignedTeamName": {
      "type": ["string", "null"],
      "maxLength": 255,
      "description": "Assigned team display name"
    },
    "migrationId": {
      "type": ["string", "null"],
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$",
      "description": "Parent migration identifier"
    },
    "migrationCode": {
      "type": ["string", "null"],
      "maxLength": 50,
      "description": "Migration code for display"
    },
    "iterationId": {
      "type": ["string", "null"],
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$",
      "description": "Parent iteration identifier"
    },
    "iterationCode": {
      "type": ["string", "null"],
      "maxLength": 50,
      "description": "Iteration code for display"
    },
    "sequenceId": {
      "type": ["string", "null"],
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$",
      "description": "Parent sequence identifier"
    },
    "phaseId": {
      "type": ["string", "null"],
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$",
      "description": "Parent phase identifier"
    },
    "createdDate": {
      "type": ["string", "null"],
      "pattern": "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d{1,9})?$",
      "description": "Step creation timestamp in ISO LocalDateTime format"
    },
    "lastModifiedDate": {
      "type": ["string", "null"],
      "pattern": "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d{1,9})?$",
      "description": "Last modification timestamp in ISO LocalDateTime format"
    },
    "isActive": {
      "type": ["boolean", "null"],
      "default": true,
      "description": "Active status indicator"
    },
    "priority": {
      "type": ["integer", "null"],
      "minimum": 1,
      "maximum": 10,
      "default": 5,
      "description": "Priority level (1-10, higher = more important)"
    },
    "stepType": {
      "type": ["string", "null"],
      "maxLength": 100,
      "description": "Step classification type"
    },
    "stepCategory": {
      "type": ["string", "null"],
      "maxLength": 100,
      "description": "Step category for grouping"
    },
    "estimatedDuration": {
      "type": ["integer", "null"],
      "minimum": 0,
      "description": "Estimated duration in minutes"
    },
    "actualDuration": {
      "type": ["integer", "null"],
      "minimum": 0,
      "description": "Actual duration in minutes"
    },
    "dependencyCount": {
      "type": ["integer", "null"],
      "minimum": 0,
      "default": 0,
      "description": "Total number of dependencies"
    },
    "completedDependencies": {
      "type": ["integer", "null"],
      "minimum": 0,
      "default": 0,
      "description": "Number of completed dependencies"
    },
    "instructionCount": {
      "type": ["integer", "null"],
      "minimum": 0,
      "default": 0,
      "description": "Total number of instructions"
    },
    "completedInstructions": {
      "type": ["integer", "null"],
      "minimum": 0,
      "default": 0,
      "description": "Number of completed instructions"
    },
    "comments": {
      "type": "array",
      "maxItems": 10,
      "default": [],
      "description": "Recent comments (limited to last 10 for performance)",
      "items": {
        "$ref": "#/definitions/CommentDTO"
      }
    },
    "hasActiveComments": {
      "type": ["boolean", "null"],
      "default": false,
      "description": "Indicates if there are active/unresolved comments"
    },
    "lastCommentDate": {
      "type": ["string", "null"],
      "pattern": "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d{1,9})?$",
      "description": "Timestamp of most recent comment in ISO LocalDateTime format"
    },
    "dependencyCompletionPercentage": {
      "type": ["number", "null"],
      "minimum": 0,
      "maximum": 100,
      "multipleOf": 0.01,
      "readOnly": true,
      "description": "Computed dependency completion percentage (0-100, read-only)"
    },
    "instructionCompletionPercentage": {
      "type": ["number", "null"],
      "minimum": 0,
      "maximum": 100,
      "multipleOf": 0.01,
      "readOnly": true,
      "description": "Computed instruction completion percentage (0-100, read-only)"
    },
    "isReadyToStart": {
      "type": ["boolean", "null"],
      "readOnly": true,
      "description": "Computed readiness status based on dependencies (read-only)"
    }
  },
  "definitions": {
    "CommentDTO": {
      "type": "object",
      "title": "Comment Data Transfer Object",
      "description": "Embedded comment structure for step comments",
      "additionalProperties": false,
      "properties": {
        "commentId": {
          "type": ["string", "null"],
          "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$",
          "description": "Comment identifier in UUID format"
        },
        "text": {
          "type": ["string", "null"],
          "maxLength": 5000,
          "description": "Comment text content"
        },
        "authorId": {
          "type": ["string", "null"],
          "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$",
          "description": "Author identifier in UUID format"
        },
        "authorName": {
          "type": ["string", "null"],
          "maxLength": 255,
          "description": "Author display name"
        },
        "createdDate": {
          "type": ["string", "null"],
          "pattern": "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d{1,9})?$",
          "description": "Comment creation timestamp in ISO LocalDateTime format"
        },
        "isActive": {
          "type": ["boolean", "null"],
          "default": true,
          "description": "Comment active status"
        },
        "isResolved": {
          "type": ["boolean", "null"],
          "default": false,
          "description": "Comment resolution status"
        }
      }
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "dependencyCount": { "type": "integer", "minimum": 1 },
          "completedDependencies": { "type": "integer" }
        },
        "required": ["dependencyCount", "completedDependencies"]
      },
      "then": {
        "properties": {
          "completedDependencies": {
            "maximum": { "$data": "1/dependencyCount" }
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "instructionCount": { "type": "integer", "minimum": 1 },
          "completedInstructions": { "type": "integer" }
        },
        "required": ["instructionCount", "completedInstructions"]
      },
      "then": {
        "properties": {
          "completedInstructions": {
            "maximum": { "$data": "1/instructionCount" }
          }
        }
      }
    }
  ],
  "$comment": "Schema validates StepInstanceDTO for US-056-A Service Layer Standardization. Supports Jackson serialization, email template rendering, and comprehensive business rule validation. Cross-field validation ensures completed counts never exceed total counts. All UUID fields validated with proper regex patterns. Timestamp fields validated for ISO LocalDateTime format."
}
